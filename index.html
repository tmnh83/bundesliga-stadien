<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>√ñsterreichische Bundesliga ‚Äì Stadionkarte</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --green: #1a7a3c;
    --green-dark: #111a14;
    --panel: #ffffff;
    --panel2: #f2f7f4;
    --border: #d4e4da;
    --text: #1a2b1f;
    --muted: #6b8070;
    --accent: #1a7a3c;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--panel2);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }

  /* HEADER */
  header {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 0 24px;
    height: 56px;
    background: var(--green-dark);
    border-bottom: 1px solid #0a100c;
    flex-shrink: 0;
    z-index: 1000;
  }
  .logo-badge {
    background: var(--green);
    color: #fff;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 13px;
    letter-spacing: 1px;
    padding: 3px 10px 2px;
    border-radius: 3px;
  }
  header h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    letter-spacing: 2px;
    color: #fff;
  }
  .header-meta {
    margin-left: auto;
    font-size: 12px;
    color: #7aaa88;
    letter-spacing: 0.5px;
  }
  .header-copy {
    font-size: 0.72rem;
    color: rgba(255,255,255,0.45);
    white-space: nowrap;
  }

  /* LAYOUT */
  .app-body {
    display: flex;
    flex: 1;
    min-height: 0;
    overflow: visible;
  }

  /* SIDEBAR */
  .sidebar {
    width: 320px;
    background: var(--panel);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    max-height: calc(100vh - 56px);
    flex-shrink: 0;
  }
  .sidebar-header {
    padding: 12px 20px 10px;
    border-bottom: 1px solid var(--border);
    background: var(--panel);
  }
  .sidebar-header h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 16px;
    letter-spacing: 2px;
    color: var(--muted);
    margin-bottom: 10px;
  }
  .search-box {
    width: 100%;
    background: var(--panel2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 12px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
  }
  .search-box:focus { border-color: var(--green); }
  .search-box::placeholder { color: var(--muted); }

  .stadium-list {
    overflow-y: auto;
    flex: 1;
    padding: 8px 0;
    background: var(--panel);
  }
  .stadium-list::-webkit-scrollbar { width: 4px; }
  .stadium-list::-webkit-scrollbar-track { background: var(--panel); }
  .stadium-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .stadium-item {
    padding: 12px 20px;
    cursor: pointer;
    border-left: 4px solid transparent;
    transition: all 0.15s;
    border-bottom: 1px solid var(--border);
  }
  .stadium-item:hover { filter: brightness(0.96); }
  .stadium-item.active { background: #fff !important; box-shadow: 0 0 0 2px var(--active-color, #1a7a3c); }
  .item-club {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 2px;
  }
  .item-stadium {
    font-size: 12px;
    color: var(--muted);
  }
  .item-cap {
    font-size: 11px;
    color: var(--accent);
    margin-top: 3px;
    font-weight: 500;
  }

  /* MAP wrapper */
  .map-wrapper {
    position: relative;
    flex: 1;
    min-height: 0;
  }
  #map {
    flex: 1;
    z-index: 1;
  }

  /* INFO PANEL */
  .info-panel {
    width: 300px;
    background: var(--panel);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    max-height: calc(100vh - 56px);
    flex-shrink: 0;
    transition: all 0.3s ease;
  }
  .info-panel::-webkit-scrollbar { width: 4px; }
  .info-panel::-webkit-scrollbar-track { background: var(--panel); }
  .info-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .info-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--muted);
    text-align: center;
    padding: 40px 20px;
    gap: 12px;
  }
  .info-placeholder svg { opacity: 0.3; }
  .info-placeholder p { font-size: 13px; line-height: 1.6; }

  .info-content { padding: 24px 20px; display: none; }
  .info-content.visible { display: block; }

  .info-club-tag {
    display: inline-block;
    background: var(--green);
    color: #fff;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 16px;
    letter-spacing: 1.5px;
    padding: 4px 10px;
    border-radius: 4px;
    margin-bottom: 10px;
  }
  .info-stadium-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 26px;
    letter-spacing: 1.5px;
    line-height: 1.1;
    color: var(--text);
    margin-bottom: 6px;
  }
  .info-address {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 20px;
    line-height: 1.5;
  }

  .info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
  }
  .info-stat {
    background: var(--panel2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
  }
  .stat-label {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 4px;
  }
  .stat-value {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
  }
  .stat-value.accent { color: var(--green); }

  .section-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 13px;
    letter-spacing: 2px;
    color: var(--muted);
    margin-bottom: 10px;
  }

  .oepnv-list {
    list-style: none;
    margin-bottom: 20px;
  }
  .oepnv-list li {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    line-height: 1.5;
    color: var(--text);
  }
  .oepnv-list li:last-child { border-bottom: none; }
  .transport-icon {
    flex-shrink: 0;
    width: 22px;
    height: 22px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
  }
  .icon-u { background: #1a5fa8; color: #fff; }
  .icon-s { background: #2e8b57; color: #fff; }
  .icon-b { background: #c8860a; color: #fff; }
  .icon-t { background: #9b1f26; color: #fff; }
  .icon-p { background: #555; color: #fff; }

  .directions-btn {
    display: block;
    width: 100%;
    padding: 12px;
    background: var(--green);
    color: #fff;
    border: none;
    border-radius: 8px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 16px;
    letter-spacing: 2px;
    cursor: pointer;
    transition: opacity 0.2s;
    text-align: center;
    text-decoration: none;
    margin-top: 8px;
  }
  .directions-btn:hover { opacity: 0.85; }
  .anreise-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
    margin-top: 8px;
  }
  .anreise-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 10px 6px;
    border-radius: 8px;
    text-decoration: none;
    font-size: .72rem;
    font-weight: 700;
    letter-spacing: .03em;
    transition: opacity 0.2s, transform 0.15s;
    text-align: center;
    line-height: 1.2;
  }
  .anreise-btn:hover { opacity: 0.85; transform: translateY(-1px); }
  .anreise-btn .anreise-icon { font-size: 1.3rem; }
  .anreise-btn.auto   { background: #1a7a3c; color: #fff; }
  .anreise-btn.oepnv  { background: #2980b9; color: #fff; }
  .anreise-btn.zug    { background: #c0392b; color: #fff; }

  /* Leaflet popup override */
  .leaflet-popup-content-wrapper {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    color: var(--text);
  }
  .leaflet-popup-tip { background: #fff; }
  .leaflet-popup-content { margin: 14px 16px; }
  .popup-club { font-size: 10px; color: var(--green); font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
  .popup-name { font-family: 'Bebas Neue', sans-serif; font-size: 18px; letter-spacing: 1px; color: var(--text); margin: 2px 0 6px; }
  .popup-cap { font-size: 11px; color: var(--muted); }
  .popup-detail-btn {
    display: inline-block;
    margin-top: 8px;
    padding: 5px 12px;
    background: var(--green);
    color: #fff;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    font-family: 'DM Sans', sans-serif;
  }

  /* Custom marker */
  .custom-marker {
    width: 32px;
    height: 32px;
    background: #1a7a3c;
    border: 2px solid #fff;
    border-radius: 50% 50% 50% 0;
    transform: rotate(-45deg);
    box-shadow: 0 3px 12px rgba(0,0,0,0.3);
  }

  /* ‚îÄ‚îÄ MOBILE NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .mobile-tabs { display: none; }

  /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  @media (max-width: 768px) {

    header {
      padding: 0 12px;
      height: 48px;
      gap: 8px;
    }
    body {
      display: block;
      min-height: 0;
    }
    header h1 { font-size: 16px; letter-spacing: 1.5px; }
    .logo-badge { font-size: 11px; padding: 2px 7px 1px; flex-shrink: 0; }
    .header-copy {
      font-size: 0.6rem;
      color: rgba(255,255,255,0.35);
      white-space: nowrap;
      margin-left: auto;
    }
    .header-meta { display: none; }

    .app-body {
      flex-direction: column;
      flex: none;
      min-height: 0;
      overflow: visible;
    }

    /* Alle Tab-Panels verstecken per default */
    .sidebar,
    .map-wrapper,
    .info-panel {
      display: none;
    }
    .sidebar-header h2 { margin-bottom: 0; }

    /* 2-column grid for stadium list */
    .stadium-list {
      display: grid;
      grid-template-columns: 1fr;
      padding: 8px;
      gap: 6px;
    }
    .stadium-item {
      padding: 8px 12px;
      border-bottom: none;
      border: 1px solid var(--border);
      border-radius: 8px;
      border-left: 4px solid transparent;
    }
    .stadium-item.active { background: #fff !important; box-shadow: 0 0 0 2px var(--active-color, #1a7a3c); }
    .item-club { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
    .item-stadium-cap { display: flex; align-items: center; gap: 8px; }
    .item-stadium { font-size: 11px; color: var(--muted); flex: 1; min-width: 0; }
    .item-cap { font-size: 11px; color: var(--accent); font-weight: 500; white-space: nowrap; flex-shrink: 0; }
    .item-club { font-size: 12px; }
    .item-stadium { font-size: 11px; }
    .item-cap { font-size: 10px; }

    /* Map: full width, fixed height */
    .map-wrapper {
      width: 100%;
      height: calc(100vh - 48px - 52px);
      position: relative;
      flex: none;
    }
    .map-wrapper.tab-active { display: block; }

    /* Sidebar tab-active */
    .sidebar {
      width: 100%;
      max-height: calc(100vh - 48px - 52px);
      border-right: none;
      border-bottom: 1px solid var(--border);
      overflow-y: auto;
      flex-shrink: 0;
    }
    .sidebar.tab-active { display: flex; }

    /* Info panel: full width scrollable */
    .info-panel {
      width: 100%;
      max-height: calc(100vh - 48px - 52px);
      border-left: none;
      border-top: 1px solid var(--border);
      overflow-y: auto;
      padding-bottom: 80px;
    }
    .info-panel.tab-active { display: flex; }

    /* Bottom tab bar */
    .mobile-tabs {
      display: flex;
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: 52px;
      background: var(--green-dark);
      border-top: 2px solid var(--green);
      z-index: 2000;
    }
    .mobile-tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      color: rgba(255,255,255,0.5);
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      cursor: pointer;
      border: none;
      background: transparent;
      font-family: 'DM Sans', sans-serif;
      transition: color 0.15s, background 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    .mobile-tab .tab-icon { font-size: 18px; line-height: 1; }
    .mobile-tab.active { color: #fff; background: rgba(26,122,60,0.35); }
    .mobile-tab.active .tab-label { color: #7aff9a; }

    /* Distanz section */
    section { padding: 1rem 1rem 80px; }
    section h2 { font-size: .95rem !important; }
    .dist-row-top { flex-direction: column !important; gap: .6rem !important; }
    #distResult { font-size: 1.2rem !important; }
    #distDrive  { font-size: .8rem !important; }
    .dist-drive-col { display: none; }

    /* Map legend smaller & above bottom nav */
    .map-legend {
      bottom: 60px !important;
      font-size: 0.65rem !important;
      padding: 6px 8px !important;
    }
  }

  @media (max-width: 380px) {
    header h1 { font-size: 14px; }
  }
</style>
</head>
<body>

<header>
  <div class="logo-badge">BUNDESLIGA</div>
  <h1>STADIONKARTE 2025/26</h1>
  <span class="header-copy">&copy; 2026 Gerald Emprechtinger</span>
  <div class="header-meta">12 Vereine</div>
</header>

<div class="app-body">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Alle Stadien</h2>
    </div>
    <div class="stadium-list" id="stadiumList"></div>
  </div>

  <!-- MAP -->
  <div class="map-wrapper tab-active" id="mapWrapper">
    <div id="map" style="width:100%;height:100%;"></div>
  </div>

  <!-- INFO PANEL -->
  <div class="info-panel" id="infoPanel">
    <div class="info-placeholder" id="infoPlaceholder">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
        <circle cx="12" cy="9" r="2.5"/>
      </svg>
      <p>Klicke auf ein Stadion in der Karte oder in der Liste f√ºr Details &amp; √ñPNV-Verbindungen.</p>
    </div>
    <div class="info-content" id="infoContent"></div>
  </div>
</div>

<!-- MOBILE BOTTOM TABS -->
<nav class="mobile-tabs">
  <button class="mobile-tab" id="tab-list" onclick="switchTab('list')">
    <span class="tab-icon">üìã</span>
    <span class="tab-label">Vereine</span>
  </button>
  <button class="mobile-tab active" id="tab-map" onclick="switchTab('map')">
    <span class="tab-icon">üó∫Ô∏è</span>
    <span class="tab-label">Karte</span>
  </button>
  <button class="mobile-tab" id="tab-detail" onclick="switchTab('detail')">
    <span class="tab-icon">üèüÔ∏è</span>
    <span class="tab-label">Details</span>
  </button>
  <button class="mobile-tab" id="tab-dist" onclick="switchTab('dist')">
    <span class="tab-icon">üìè</span>
    <span class="tab-label">Distanz</span>
  </button>
</nav>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
const stadien = [
  {
    id: 1,
    verein: "FK Austria Wien",
    farbe: "#4B1E78",
    stadion: "Generali Arena",
    adresse: "Horrplatz 1, 1100 Wien",
    kapazitaet: 15600,
    baujahr: "1925, Umbau 2016‚Äì2018",
    lat: 48.16233,
    lng: 16.38717,
    oepnv: [
      { typ: "U", linie: "U1", text: "Station Altes Landgut (direkt am Stadion, ca. 5 Min. Fu√üweg)" },
      { typ: "T", linie: "62", text: "Stra√üenbahn 62, Station Kliebergasse" },
      { typ: "B", linie: "7A", text: "Bus 7A, Station Fischhof / Generali Arena" }
    ]
  },
  {
    id: 2,
    verein: "SK Rapid Wien",
    farbe: "#028940",
    stadion: "Allianz Stadion",
    adresse: "Gerhard-Hanappi-Platz 1, 1140 Wien",
    kapazitaet: 28600,
    baujahr: "2016",
    lat: 48.19806,
    lng: 16.26528,
    oepnv: [
      { typ: "U", linie: "U4", text: "Endstation H√ºtteldorf, 5 Min. Fu√üweg" },
      { typ: "S", linie: "S50", text: "S-Bahn S50, Bahnhof H√ºtteldorf" },
      { typ: "T", linie: "49", text: "Stra√üenbahn 49, Station Deutschordenstra√üe (direkt am Stadion)" }
    ]
  },
  {
    id: 3,
    verein: "Red Bull Salzburg",
    farbe: "#CC0000",
    stadion: "Red Bull Arena",
    adresse: "Stadionstra√üe 2/3, 5071 Wals-Siezenheim",
    kapazitaet: 17218,
    baujahr: "2003, Umbau 2008",
    lat: 47.81681,
    lng: 12.99931,
    oepnv: [
      { typ: "B", linie: "2", text: "OBus Linie 2, Station Red Bull Arena" },
      { typ: "B", linie: "180", text: "Bus 180 vom HBF Salzburg (Spieltage)" },
      { typ: "P", linie: "P", text: "Gro√ües Parkplatzangebot direkt am Stadion" }
    ]
  },
  {
    id: 4,
    verein: "LASK",
    farbe: "#1A1A1A",
    stadion: "Raiffeisen Arena",
    adresse: "Helmut-K√∂glberger-Platz 1, 4020 Linz",
    kapazitaet: 19080,
    baujahr: "2023",
    lat: 48.29372,
    lng: 14.27658,
    oepnv: [
      { typ: "B", linie: "17/19/46/45A", text: "Bus direkt zur Haltestelle Stadion" },
      { typ: "B", linie: "27", text: "Bus 27, Haltestelle Botanischer Garten" },
      { typ: "P", linie: "P", text: "Parkhaus am Stadion verf√ºgbar" }
    ]
  },
  {
    id: 5,
    verein: "Sturm Graz",
    farbe: "#1A1A1A",
    stadion: "Merkur Versicherung Arena",
    adresse: "Stadionplatz 1, 8042 Graz",
    kapazitaet: 16364,
    baujahr: "1997",
    lat: 47.04685,
    lng: 15.45456,
    oepnv: [
      { typ: "T", linie: "4", text: "Stra√üenbahn Linie 4, Station Puntigam" },
      { typ: "T", linie: "5", text: "Stra√üenbahn Linie 5, Station Liebenauer Tangente" },
      { typ: "B", linie: "65", text: "Bus 65, Station Stadion Liebenau" }
    ]
  },
  {
    id: 6,
    verein: "Wolfsberger AC",
    farbe: "#1A1A1A",
    stadion: "Lavanttal Arena",
    adresse: "Don-Bosco-Weg 1, 9400 Wolfsberg",
    kapazitaet: 8100,
    baujahr: "1984, Trib√ºnenausbau 1988",
    lat: 46.82640,
    lng: 14.85180,
    oepnv: [
      { typ: "S", linie: "S6", text: "S-Bahn S6, Bahnhof Wolfsberg (15 Min. Fu√üweg)" },
      { typ: "B", linie: "5", text: "Stadtbus Wolfsberg, Linie 5 zum Stadion" },
      { typ: "P", linie: "P", text: "Ausreichend Parkpl√§tze vorhanden" }
    ]
  },
  {
    id: 7,
    verein: "GAK 1902",
    farbe: "#CC0000",
    stadion: "Merkur Arena",
    adresse: "Ivica-Osim-Platz 1, 8041 Graz",
    kapazitaet: 16364,
    baujahr: "1997",
    lat: 47.04543,
    lng: 15.45456,
    oepnv: [
      { typ: "T", linie: "4", text: "Stra√üenbahn Linie 4, Haltestelle Stadion Liebenau (direkt am Stadion)" },
      { typ: "T", linie: "5", text: "Stra√üenbahn Linie 5, Haltestelle Liebenauer Tangente" },
      { typ: "P", linie: "P", text: "Tiefgarage im Stadion sowie P+R MURPARK in der N√§he" }
    ]
  },
  {
    id: 8,
    verein: "TSV Hartberg",
    farbe: "#003DA5",
    stadion: "Profertil Arena",
    adresse: "Otto-Gerlitz-Platz 2, 8230 Hartberg",
    kapazitaet: 5024,
    baujahr: "1946, Umbau 2025",
    lat: 47.28097,
    lng: 15.97722,
    oepnv: [
      { typ: "S", linie: "S31", text: "S-Bahn S31, Bahnhof Hartberg (10 Min. Fu√üweg)" },
      { typ: "B", linie: "606", text: "Regionalbus 606 aus Graz, Haltestelle Hartberg Bahnhof" },
      { typ: "P", linie: "P", text: "Parkpl√§tze am und beim Stadion" }
    ]
  },
  {
    id: 9,
    verein: "WSG Tirol",
    farbe: "#2E7D32",
    stadion: "Tivoli Stadion Tirol",
    adresse: "Stadionstra√üe 1, 6020 Innsbruck",
    kapazitaet: 15200,
    baujahr: "2000",
    lat: 47.25597,
    lng: 11.41078,
    oepnv: [
      { typ: "T", linie: "1", text: "Stra√üenbahn Linie 1, Station Bergisel" },
      { typ: "B", linie: "J", text: "Bus J, Station Tivoli / Stadion" },
      { typ: "S", linie: "S3", text: "S-Bahn S3/S4, Bahnhof Innsbruck HBF (20 Min. zu Fu√ü)" }
    ]
  },
  {
    id: 10,
    verein: "SCR Altach",
    farbe: "#1A1A1A",
    stadion: "Stadion Schnabelholz",
    adresse: "Rheinstra√üe 4, 6844 Altach",
    kapazitaet: 8200,
    baujahr: "1990, S√ºdtrib√ºne 2018, Nordtrib√ºne 2019",
    lat: 47.35364,
    lng: 9.63719,
    oepnv: [
      { typ: "S", linie: "S3", text: "S-Bahn S3, Bahnhof Altach (Shuttlebus zum Stadion am Spieltag)" },
      { typ: "B", linie: "Shuttle", text: "Gratis-Shuttlebus Bahnhof Altach ‚Üî Stadion (Tages-/Dauerkarte gilt als Ticket)" },
      { typ: "P", linie: "P", text: "Parkpl√§tze direkt beim Stadion, Zufahrt A14 Ausfahrt Altach" }
    ]
  },
  {
    id: 11,
    verein: "FC Blau-Wei√ü Linz",
    farbe: "#003DA5",
    stadion: "Hofmann Personal Stadion",
    adresse: "Stra√üerau 3, 4020 Linz",
    kapazitaet: 5595,
    baujahr: "2023",
    lat: 48.31639,
    lng: 14.29881,
    oepnv: [
      { typ: "T", linie: "1/2/3/4", text: "Stra√üenbahn, Haltestelle Hauptplatz (ca. 10 Min. Fu√üweg)" },
      { typ: "T", linie: "1/2", text: "Stra√üenbahn, Haltestellen Peuerbachstra√üe / Linke Br√ºckenstra√üe" },
      { typ: "B", linie: "12/25", text: "Bus, Haltestellen Donauparkstadion / Parkbad / Heilhamer Weg" }
    ]
  },
  {
    id: 12,
    verein: "SV Ried",
    farbe: "#1a7a3c",
    stadion: "BWT Ober√∂sterreichische Arena",
    adresse: "Volksfestplatz 1, 4910 Ried im Innkreis",
    kapazitaet: 7336,
    baujahr: "2003",
    lat: 48.20781,
    lng: 13.47856,
    oepnv: [
      { typ: "S", linie: "S4", text: "S-Bahn S4, Bahnhof Ried im Innkreis (ca. 25 Min. Fu√üweg)" },
      { typ: "B", linie: "430", text: "Regionalbus 430 ab Wels, Haltestelle Ried Bahnhof" },
      { typ: "P", linie: "P", text: "Parkpl√§tze am Volksfestplatz direkt beim Stadion" }
    ]
  }
];

// Transport-Typ Config
const transportConfig = {
  U: { icon: 'U', cls: 'icon-u' },
  S: { icon: 'S', cls: 'icon-s' },
  B: { icon: 'B', cls: 'icon-b' },
  T: { icon: 'T', cls: 'icon-t' },
  P: { icon: 'P', cls: 'icon-p' }
};

// Init Map
const map = L.map('map', {
  center: [47.6, 13.8],
  zoom: 7,
  zoomControl: true
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  maxZoom: 19
}).addTo(map);

// Custom marker icon
// Capacity-scaled circle marker
// Area proportional to capacity: r = scale * sqrt(capacity)
const CAP_MIN = Math.min(...stadien.map(s => s.kapazitaet));
const CAP_MAX = Math.max(...stadien.map(s => s.kapazitaet));
const R_MIN = 10, R_MAX = 34;

function capToRadius(cap) {
  // Area-proportional scaling
  const t = (Math.sqrt(cap) - Math.sqrt(CAP_MIN)) / (Math.sqrt(CAP_MAX) - Math.sqrt(CAP_MIN));
  return Math.round(R_MIN + t * (R_MAX - R_MIN));
}

function createMarkerIcon(active = false, cap = 10000, farbe = '#1a7a3c') {
  const r = 12;
  const size = r * 2;
  const bg = active ? '#fff' : farbe;
  const border = active ? `3px solid ${farbe}` : '2.5px solid #fff';
  const shadow = active ? `0 0 0 3px ${farbe}88, 0 3px 10px rgba(0,0,0,0.35)` : '0 2px 6px rgba(0,0,0,0.4)';
  return L.divIcon({
    html: `<div style="
      width:${size}px;
      height:${size}px;
      background:${bg};
      border:${border};
      border-radius:50%;
      box-shadow:${shadow};
      transition:all 0.25s;
      display:flex;align-items:center;justify-content:center;
    "></div>`,
    className: '',
    iconSize: [size, size],
    iconAnchor: [r, r]
  });
}

let activeMarkerId = null;
const markers = {};

// Build sidebar list
const listEl = document.getElementById('stadiumList');

function buildList() {
  listEl.innerHTML = '';
  stadien
    .slice()
    .sort((a, b) => b.kapazitaet - a.kapazitaet)
    .forEach(s => {
      const item = document.createElement('div');
      const isActive = activeMarkerId === s.id;
      const tint = s.farbe === '#1A1A1A' ? 'rgba(0,0,0,0.04)' : s.farbe + '18';
      item.className = 'stadium-item' + (isActive ? ' active' : '');
      item.style.borderLeftColor = s.farbe;
      item.style.background = tint;
      item.style.setProperty('--active-color', s.farbe);
      item.dataset.id = s.id;
      item.innerHTML = `
        <div class="item-club">${s.verein}</div>
        <div class="item-stadium-cap">
          <span class="item-stadium">${s.stadion}</span>
          <span class="item-cap">‚¨° ${s.kapazitaet.toLocaleString('de-AT')}</span>
        </div>
      `;
      item.addEventListener('click', () => {
        selectStadium(s.id, { suppressTabSwitch: true });
        if (window.innerWidth <= 768 && typeof switchTab === 'function') {
          switchTab('map');
        }
      });
      listEl.appendChild(item);
    });
}

// Initial list build
buildList();

// Shared-venue config: Paare die dasselbe Stadion teilen
const SHARED_VENUES = [
  { ids: [5, 7], lat: 47.04614, lng: 15.45456 } // Sturm & GAK ‚Äì Mittelpunkt
];
const ZOOM_SPLIT_THRESHOLD = 14; // unter diesem Zoom: Kombi-Marker

function createComboMarkerIcon(stadienPair) {
  const r = 12;
  const size = r * 2;
  const [c1, c2] = stadienPair.map(s => s.farbe);
  return L.divIcon({
    html: `<div style="
      width:${size}px;height:${size}px;border-radius:50%;
      background: conic-gradient(${c1} 0deg 180deg, ${c2} 180deg 360deg);
      border:2.5px solid #fff;
      box-shadow:0 2px 6px rgba(0,0,0,0.4);
    "></div>`,
    className: '',
    iconSize: [size, size],
    iconAnchor: [r, r]
  });
}

const comboMarkers = [];

SHARED_VENUES.forEach(venue => {
  const pair = venue.ids.map(id => stadien.find(s => s.id === id));
  const comboMarker = L.marker([venue.lat, venue.lng], {
    icon: createComboMarkerIcon(pair),
    zIndexOffset: 100
  }).addTo(map);

  comboMarker.bindPopup(`
    <div class="popup-club" style="margin-bottom:6px;">Gemeinsames Stadion</div>
    ${pair.map(s => `
      <div style="margin-bottom:4px;">
        <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${s.farbe};margin-right:5px;vertical-align:middle;"></span>
        <button class="popup-detail-btn" style="background:${s.farbe};" onclick="selectStadium(${s.id})">${s.verein} ‚Üí</button>
      </div>
    `).join('')}
  `, { maxWidth: 240 });

  comboMarkers.push({ marker: comboMarker, ids: venue.ids });
});

function updateSharedMarkerVisibility() {
  const zoom = map.getZoom();
  const splitMode = zoom >= ZOOM_SPLIT_THRESHOLD;

  SHARED_VENUES.forEach((venue, i) => {
    const combo = comboMarkers[i];
    // Kombi-Marker: sichtbar unter Schwellenwert
    if (splitMode) {
      combo.marker.setOpacity(0);
      combo.marker.options.interactive = false;
    } else {
      combo.marker.setOpacity(1);
      combo.marker.options.interactive = true;
    }
    // Einzel-Marker: sichtbar ab Schwellenwert
    venue.ids.forEach(id => {
      if (markers[id]) {
        markers[id].setOpacity(splitMode ? 1 : 0);
        markers[id].options.interactive = splitMode;
      }
    });
  });
}

map.on('zoomend', updateSharedMarkerVisibility);

stadien.forEach(s => {
  const marker = L.marker([s.lat, s.lng], { icon: createMarkerIcon(false, s.kapazitaet, s.farbe) }).addTo(map);
  marker.bindPopup(`
    <div class="popup-club">${s.verein}</div>
    <div class="popup-name">${s.stadion}</div>
    <div class="popup-cap">‚¨° ${s.kapazitaet.toLocaleString('de-AT')} Pl√§tze</div>
    <button class="popup-detail-btn" onclick="selectStadium(${s.id})">Details &amp; √ñPNV ‚Üí</button>
  `, { maxWidth: 220 });
  marker.on('click', () => selectStadium(s.id));
  markers[s.id] = marker;
});

// Initial visibility check
updateSharedMarkerVisibility();

// Select stadium
function selectStadium(id, options = {}) {
  const s = stadien.find(x => x.id === id);
  if (!s) return;

  // Reset previous marker
  if (activeMarkerId && markers[activeMarkerId]) {
    const prevStadion = stadien.find(x => x.id === activeMarkerId);
    markers[activeMarkerId].setIcon(createMarkerIcon(false, prevStadion ? prevStadion.kapazitaet : 10000, prevStadion ? prevStadion.farbe : '#1a7a3c'));
  }

  activeMarkerId = id;
  markers[id].setIcon(createMarkerIcon(true, s.kapazitaet, s.farbe));

  // flyTo nur wenn explizit gew√ºnscht (User-Klick), nicht beim App-Init
  if (options.flyTo !== false) {
    if (window.innerWidth <= 768) {
      // Karte ist m√∂glicherweise noch nicht sichtbar ‚Äì flyTo als pending merken
      map._pendingFlyTo = { lat: s.lat, lng: s.lng };
    } else {
      map.flyTo([s.lat, s.lng], 16, { duration: 1.2 });
    }
    map.once('moveend', updateSharedMarkerVisibility);
  }

  // Sync distance widget
  const selA = document.getElementById('distA');
  if (selA) {
    const idx = stadien.findIndex(x => x.id === id);
    selA.selectedIndex = idx;
    calcDistance();
    buildAllDistances(id);
  }

  // Update sidebar active state
  buildList();

  // Update info panel
  // Heimst√§rke block
  const hd = getHeimData(s.verein);
  let heimHtml = '';
  if (hd) {
    const diff = hd.heimPts - hd.auswPts;
    const diffStr = diff > 0 ? `+${diff}` : `${diff}`;
    const diffColor = diff > 0 ? '#1a7a3c' : diff < 0 ? '#c0392b' : '#888';
    const label = diff > 3 ? 'üè† Starke Heimmannschaft' : diff < -3 ? '‚úàÔ∏è Besser ausw√§rts' : '‚öñÔ∏è Ausgeglichen';
    heimHtml = `
      <div class="section-title">Heimst√§rke (20. Spieltag)</div>
      <div style="padding:0 1.2rem 1rem;display:flex;flex-direction:column;gap:10px;">
        <div>
          <div style="font-size:.75rem;color:#888;margin-bottom:4px;">üè† Heim (${hd.heimSp} Spiele)</div>
          ${heimstaerkeBar(hd.heimPts, hd.heimSp, '#1a7a3c')}
        </div>
        <div>
          <div style="font-size:.75rem;color:#888;margin-bottom:4px;">‚úàÔ∏è Ausw√§rts (${hd.auswSp} Spiele)</div>
          ${heimstaerkeBar(hd.auswPts, hd.auswSp, '#e67e22')}
        </div>
        <div style="font-size:.8rem;padding:6px 10px;background:#f8f8f8;border-radius:6px;border-left:3px solid ${diffColor};">
          ${label} &nbsp;¬∑&nbsp; <span style="color:${diffColor};font-weight:700;">${diffStr} Punkte</span> Differenz
        </div>
        <div style="font-size:.7rem;color:#bbb;text-align:right;padding-top:4px;">Stand: 23.02.2026 ¬∑ 20. Spieltag</div>
      </div>`;
  }

  const oepnvHtml = s.oepnv.map(o => {
    const cfg = transportConfig[o.typ] || transportConfig.B;
    return `<li>
      <span class="transport-icon ${cfg.cls}">${cfg.icon}</span>
      <span><strong>${o.linie}:</strong> ${o.text}</span>
    </li>`;
  }).join('');

  // Textfarbe je nach Helligkeit der Vereinsfarbe bestimmen
  const hex = s.farbe.replace('#', '');
  const r2 = parseInt(hex.slice(0,2),16), g2 = parseInt(hex.slice(2,4),16), b2 = parseInt(hex.slice(4,6),16);
  const luminance = (0.299*r2 + 0.587*g2 + 0.114*b2) / 255;
  const headerTextColor = luminance > 0.5 ? '#1a2b1f' : '#ffffff';
  const headerBg = s.farbe === '#1A1A1A' ? '#2d2d2d' : s.farbe;

  document.getElementById('infoPlaceholder').style.display = 'none';
  const content = document.getElementById('infoContent');
  content.classList.add('visible');
  content.innerHTML = `
    <div style="background:${headerBg};padding:20px 20px 16px;margin:-24px -20px 20px;">
      <div style="display:inline-block;background:rgba(255,255,255,0.2);color:${headerTextColor};font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:1.5px;padding:3px 8px;border-radius:3px;margin-bottom:8px;">${s.verein}</div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:1.5px;line-height:1.1;color:${headerTextColor};margin-bottom:5px;">${s.stadion}</div>
      <div style="font-size:12px;color:${headerTextColor};opacity:0.75;line-height:1.5;">${s.adresse}</div>
    </div>
    <div class="info-grid">
      <div class="info-stat">
        <div class="stat-label">Kapazit√§t</div>
        <div class="stat-value accent">${s.kapazitaet.toLocaleString('de-AT')}</div>
      </div>
      <div class="info-stat">
        <div class="stat-label">√ñPNV</div>
        <div class="stat-value">${s.oepnv.length} Linien</div>
      </div>
      ${s.baujahr ? `<div class="info-stat" style="grid-column:1/-1;">
        <div class="stat-label">Baujahr / Renovierung</div>
        <div class="stat-value" style="font-size:14px;">${s.baujahr}</div>
      </div>` : ''}
    </div>
    <div class="section-title">√ñPNV Anbindung</div>
    <ul class="oepnv-list">${oepnvHtml}</ul>
    <div style="font-size:.7rem;color:#aaa;background:#f9f9f9;border-left:3px solid #ddd;padding:7px 10px;border-radius:0 4px 4px 0;margin-bottom:1rem;line-height:1.5;">
      ‚ö†Ô∏è √ñPNV-Angaben ohne Gew√§hr ‚Äì nicht offiziell verifiziert. Fu√üwegzeiten sind Richtwerte. Bitte vor dem Spieltag √ºber <a href="https://www.oebb.at" target="_blank" style="color:#1a7a3c;">√ñBB</a> oder <a href="https://www.wienerlinien.at" target="_blank" style="color:#1a7a3c;">Wiener Linien</a> pr√ºfen.
    </div>
    <div style="font-size:.75rem;color:#888;margin:1rem 0 0;font-weight:600;text-transform:uppercase;letter-spacing:.05em;">Anreise planen</div>
    <div class="anreise-grid">
      <a class="anreise-btn auto"
         href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(s.adresse)}&travelmode=driving"
         target="_blank">
        <span class="anreise-icon">üöó</span>Auto<br><span style="font-weight:400;font-size:.68rem;">Google Maps</span>
      </a>
      <a class="anreise-btn oepnv"
         href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(s.adresse)}&travelmode=transit"
         target="_blank">
        <span class="anreise-icon">üöå</span>√ñffis<br><span style="font-weight:400;font-size:.68rem;">Google Maps</span>
      </a>
      <a class="anreise-btn zug"
         href="https://fahrplan.oebb.at/bin/query.exe/dn?Z=${encodeURIComponent(s.stadion + ', ' + s.adresse.split(',').slice(-1)[0].trim())}&START=1"
         target="_blank">
        <span class="anreise-icon">üöÇ</span>Zug<br><span style="font-weight:400;font-size:.68rem;">√ñBB</span>
      </a>
    </div>
    <div style="margin-top:1.5rem;">${heimHtml}</div>
  `;

  // On mobile: switch to detail tab (called from popup or map marker click)
  // List clicks and init suppress this via options
  if (window.innerWidth <= 768 && typeof switchTab === 'function' && !options.suppressTabSwitch) {
    switchTab('detail');
  }
}

// Make global for popup button
window.selectStadium = selectStadium;

// ‚îÄ‚îÄ MOBILE TAB SWITCHING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TABS = {
  list:   { btn: 'tab-list',   el: '.sidebar',    cls: 'tab-active' },
  map:    { btn: 'tab-map',    el: '#mapWrapper',  cls: 'tab-active' },
  detail: { btn: 'tab-detail', el: '.info-panel',  cls: 'tab-active' },
  dist:   { btn: 'tab-dist',   el: null,           cls: null }        // scrolls to section
};

let activeTab = 'map';

function switchTab(name) {
  activeTab = name;

  const isMobile = window.innerWidth <= 768;

  if (isMobile) {
    // Hide all mobile panels
    document.querySelector('.sidebar').classList.remove('tab-active');
    document.getElementById('mapWrapper').classList.remove('tab-active');
    document.querySelector('.info-panel').classList.remove('tab-active');
    document.getElementById('distSection').style.display = 'none';

    // Show selected panel
    if (name === 'list')   document.querySelector('.sidebar').classList.add('tab-active');
    if (name === 'map')    {
      document.getElementById('mapWrapper').classList.add('tab-active');
      setTimeout(() => {
        map.invalidateSize();
        // Auf Mobile: √ñsterreich etwas weiter rausgezoomt als Desktop
        if (!map._hasSetMobileZoom) {
          map.setView([47.6, 13.8], 6);
          map._hasSetMobileZoom = true;
        }
        // Verz√∂gerten flyTo ausf√ºhren falls einer aussteht
        if (map._pendingFlyTo) {
          const { lat, lng } = map._pendingFlyTo;
          map.flyTo([lat, lng], 16, { duration: 1.2 });
          map._pendingFlyTo = null;
        }
      }, 80);
    }
    if (name === 'detail') document.querySelector('.info-panel').classList.add('tab-active');
    if (name === 'dist')   document.getElementById('distSection').style.display = 'block';
  }

  // Update tab buttons
  ['list','map','detail','dist'].forEach(t => {
    document.getElementById('tab-' + t)?.classList.toggle('active', t === name);
  });
}
window.switchTab = switchTab;

// Initial list build
buildList();

// ‚îÄ‚îÄ DISTANZ-WIDGET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function haversine(lat1, lng1, lat2, lng2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function buildDistanceSelects() {
  const selA = document.getElementById('distA');
  const selB = document.getElementById('distB');
  stadien.forEach((s, i) => {
    selA.innerHTML += `<option value="${i}">${s.verein}</option>`;
    selB.innerHTML += `<option value="${i}">${s.verein}</option>`;
  });
  setFarthestOpponent(0);
  calcDistance();
}

// Auto-select farthest opponent for distB based on distA
function setFarthestOpponent(aIndex) {
  const a = stadien[aIndex];
  let maxKm = -1, maxIdx = -1;
  stadien.forEach((s, i) => {
    if (i === aIndex) return;
    const d = haversine(a.lat, a.lng, s.lat, s.lng);
    if (d > maxKm) { maxKm = d; maxIdx = i; }
  });
  if (maxIdx >= 0) document.getElementById('distB').selectedIndex = maxIdx;
}

function calcDistance() {
  const a = stadien[document.getElementById('distA').value];
  const b = stadien[document.getElementById('distB').value];
  const km = haversine(a.lat, a.lng, b.lat, b.lng);
  const key = cacheKey(a.id, b.id);
  const cached = driveCache[key];
  const driveEl = document.getElementById('distDrive');
  if (cached) {
    document.getElementById('distResult').textContent = km.toFixed(1) + ' km';
    driveEl.textContent = cached.dur + '  |  ' + cached.km + ' km Fahrtstrecke';
    driveEl.style.color = '#1a7a3c';
  } else {
    document.getElementById('distResult').textContent = km.toFixed(1) + ' km';
    driveEl.textContent = '‚è≥ Fahrzeit wird geladen‚Ä¶';
    driveEl.style.color = '#888';
    fetchDriveTime(a, b, key);
  }
}

function cacheKey(idA, idB) {
  return [idA, idB].sort().join('_');
}

const driveCache = {};

// ‚îÄ‚îÄ HEIMST√ÑRKE-DATEN (Stand: 20. Spieltag 2025/26, Quelle: bundesliga.at) ‚îÄ‚îÄ
const heimData = {
  // key = verein name (matched to stadien array)
  'FC Red Bull Salzburg':       { heimPts: 17, auswPts: 19, heimSp: 10, auswSp: 10 },
  'SK Puntigamer Sturm Graz':   { heimPts: 13, auswPts: 21, heimSp: 10, auswSp: 10 },
  'LASK':                       { heimPts: 19, auswPts: 14, heimSp: 10, auswSp: 10 },
  'FK Austria Wien':            { heimPts: 16, auswPts: 16, heimSp: 10, auswSp: 10 },
  'TSV Hartberg':               { heimPts: 15, auswPts: 16, heimSp: 10, auswSp: 10 },
  'SK Rapid Wien':              { heimPts: 14, auswPts: 15, heimSp: 10, auswSp: 10 },
  'SV Ried':                    { heimPts: 15, auswPts: 13, heimSp: 10, auswSp: 10 },
  'SCR Altach':                 { heimPts: 19, auswPts:  9, heimSp: 10, auswSp: 10 },
  'Wolfsberger AC':             { heimPts: 14, auswPts: 11, heimSp: 10, auswSp: 10 },
  'WSG Tirol':                  { heimPts: 15, auswPts: 10, heimSp: 10, auswSp: 10 },
  'GAK 1902':                   { heimPts: 11, auswPts:  6, heimSp: 10, auswSp: 10 },
  'FC Blau-Wei√ü Linz':          { heimPts: 10, auswPts:  4, heimSp: 10, auswSp: 10 },
};

function getHeimData(verein) {
  // fuzzy match
  for (const key of Object.keys(heimData)) {
    if (verein.includes(key) || key.includes(verein) ||
        verein.replace('SK Puntigamer ', '').includes(key.replace('SK Puntigamer ', '')) ||
        verein.replace('TSV Egger Glas ', '') === key.replace('TSV ', '') ) {
      return heimData[key];
    }
  }
  // direct lookup
  return heimData[verein] || null;
}

function heimstaerkeBar(pts, sp, color) {
  const pct = sp > 0 ? Math.round((pts / (sp * 3)) * 100) : 0;
  return `<div style="display:flex;align-items:center;gap:6px;">
    <div style="flex:1;background:#f0f0f0;border-radius:4px;height:8px;overflow:hidden;">
      <div style="width:${pct}%;background:${color};height:100%;border-radius:4px;transition:width 0.4s;"></div>
    </div>
    <span style="font-size:.78rem;font-weight:700;color:${color};min-width:28px;">${pts} Pts</span>
    <span style="font-size:.72rem;color:#aaa;">(${pct}%)</span>
  </div>`;
}


async function fetchDriveTime(a, b, key) {
  try {
    const url = `https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=false`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.routes && data.routes[0]) {
      const secs = data.routes[0].duration;
      const meters = data.routes[0].distance;
      const h = Math.floor(secs / 3600);
      const m = Math.round((secs % 3600) / 60);
      const durStr = h > 0 ? h + ' Std. ' + m + ' Min.' : m + ' Min.';
      const kmStr = (meters / 1000).toFixed(0);
      driveCache[key] = { dur: 'üöó ' + durStr, km: kmStr };
      // Refresh display if still the same pair selected
      const curA = stadien[document.getElementById('distA').value];
      const curB = stadien[document.getElementById('distB').value];
      if (cacheKey(curA.id, curB.id) === key) {
        document.getElementById('distDrive').textContent = driveCache[key].dur + '  |  ' + driveCache[key].km + ' km Fahrtstrecke';
        document.getElementById('distDrive').style.color = '#1a7a3c';
      }
    }
  } catch(e) {
    const driveEl = document.getElementById('distDrive');
    if (driveEl) { driveEl.textContent = 'Fahrzeit nicht verf√ºgbar'; driveEl.style.color = '#aaa'; }
  }
}

// Preload all drive times in background
async function preloadAllDriveTimes() {
  for (let i = 0; i < stadien.length; i++) {
    for (let j = i+1; j < stadien.length; j++) {
      const key = cacheKey(stadien[i].id, stadien[j].id);
      if (!driveCache[key]) {
        await fetchDriveTime(stadien[i], stadien[j], key);
        await new Promise(r => setTimeout(r, 150)); // throttle OSRM requests
      }
    }
  }
  // Rebuild table with full data once loaded
  const selA = document.getElementById('distA');
  if (selA) {
    const idx = parseInt(selA.value);
    buildAllDistances(stadien[idx] ? stadien[idx].id : undefined);
  }
}

function buildAllDistances(filterId) {
  const pairs = [];
  if (filterId !== undefined) {
    // Only distances from selected stadium to all others
    const base = stadien.find(x => x.id === filterId);
    stadien.filter(x => x.id !== filterId).forEach(s => {
      pairs.push({ a: base.verein, b: s.verein, idA: base.id, idB: s.id, km: haversine(base.lat, base.lng, s.lat, s.lng) });
    });
  } else {
    for (let i = 0; i < stadien.length; i++) {
      for (let j = i+1; j < stadien.length; j++) {
        pairs.push({
          a: stadien[i].verein, b: stadien[j].verein,
          idA: stadien[i].id, idB: stadien[j].id,
          km: haversine(stadien[i].lat, stadien[i].lng, stadien[j].lat, stadien[j].lng)
        });
      }
    }
  }
  pairs.sort((x, y) => y.km - x.km);
  // Update summary label
  const summary = document.getElementById('distSummary');
  if (summary) {
    summary.textContent = filterId !== undefined
      ? 'Distanzen von ' + stadien.find(x => x.id === filterId).verein + ' (gr√∂√üte ‚Üí kleinste)'
      : 'Alle Distanzen (gr√∂√üte ‚Üí kleinste)';
  }
  const tbody = document.getElementById('distTable');
  tbody.innerHTML = pairs.map((p, idx) => {
    const key = cacheKey(p.idA, p.idB);
    const drive = driveCache[key];
    const driveCell = drive
      ? '<td class="dist-drive-col" style="padding:5px 8px;text-align:right;color:#555;">' + drive.dur + '</td><td class="dist-drive-col" style="padding:5px 8px;text-align:right;color:#888;font-size:.8rem;">' + drive.km + ' km</td>'
      : '<td class="dist-drive-col" style="padding:5px 8px;text-align:right;color:#ccc;font-size:.8rem;">‚è≥</td><td class="dist-drive-col"></td>';
    return '<tr style="border-bottom:1px solid #f0f0f0;">' +
    '<td style="color:#aaa;padding:5px 8px;text-align:right;">' + (idx+1) + '</td>' +
    '<td style="padding:5px 8px;">' + p.a + '</td>' +
    '<td style="padding:5px 8px;color:#aaa;text-align:center;">‚Üî</td>' +
    '<td style="padding:5px 8px;">' + p.b + '</td>' +
    '<td style="padding:5px 8px;text-align:right;font-weight:700;color:#1a7a3c;">' + p.km.toFixed(1) + ' km</td>' +
    driveCell +
    '</tr>';
  }).join('');
}

</script>

<!-- DISTANZ-WIDGET -->
<section id="distSection" style="background:#fff;border-top:3px solid #1a7a3c;padding:1.2rem 1.5rem 80px;font-family:inherit;">
  <h2 style="margin:0 0 1.2rem;font-size:1.1rem;color:#111a14;letter-spacing:.05em;text-transform:uppercase;">Stadion-Distanzrechner</h2>
  <div class="dist-row-top" style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;margin-bottom:1.5rem;">
    <select id="distA" style="flex:1;min-width:160px;padding:8px 10px;border:1px solid #ccc;border-radius:6px;font-size:.9rem;"></select>
    <span style="font-size:1.1rem;color:#888;">‚Üî</span>
    <select id="distB" style="flex:1;min-width:160px;padding:8px 10px;border:1px solid #ccc;border-radius:6px;font-size:.9rem;"></select>
    <div style="display:flex;flex-direction:column;gap:4px;">
      <div style="font-size:1.5rem;font-weight:700;color:#1a7a3c;white-space:nowrap;" id="distResult">‚Äì km Luftlinie</div>
      <div style="font-size:.9rem;color:#888;white-space:nowrap;" id="distDrive">‚è≥ Fahrzeiten werden geladen‚Ä¶</div>
    </div>
  </div>
  <details open>
    <summary id="distSummary" style="cursor:pointer;font-size:.9rem;font-weight:600;color:#1a7a3c;margin-bottom:.8rem;">Alle Distanzen (gr√∂√üte ‚Üí kleinste)</summary>
    <div style="overflow-x:auto;margin-top:.8rem;">
      <table style="width:100%;border-collapse:collapse;font-size:.85rem;">
        <thead>
          <tr style="border-bottom:2px solid #1a7a3c;color:#555;text-align:left;">
            <th style="padding:5px 8px;">#</th>
            <th style="padding:5px 8px;">Stadion A</th>
            <th></th>
            <th style="padding:5px 8px;">Stadion B</th>
            <th style="padding:5px 8px;text-align:right;">Luftlinie</th>
            <th class="dist-drive-col" style="padding:5px 8px;text-align:right;">Fahrzeit</th>
            <th class="dist-drive-col" style="padding:5px 8px;text-align:right;">Strecke</th>
          </tr>
        </thead>
        <tbody id="distTable"></tbody>
      </table>
    </div>
  </details>
</section>

<script>
buildDistanceSelects();
buildAllDistances();
preloadAllDriveTimes();

// Ried als aktives Stadion: Marker + Info-Panel, aber KEIN flyTo beim Start
const riedId = stadien.find(s => s.verein === 'SV Ried').id;
const riedIdx = stadien.findIndex(s => s.verein === 'SV Ried');
selectStadium(riedId, { flyTo: false, suppressTabSwitch: true });

// distA auf Ried, distB automatisch auf weitesten Gegner
document.getElementById('distA').selectedIndex = riedIdx;
setFarthestOpponent(riedIdx);
calcDistance();
buildAllDistances(riedId);

if (window.innerWidth <= 768) {
  // Mobile: distSection verstecken, Vereine-Tab als Standard
  document.getElementById('distSection').style.display = 'none';
  switchTab('list');
} else {
  // Desktop: Karte auf √ñsterreich-Gesamt√ºbersicht
  map.setView([47.6, 13.8], 7);
}

document.getElementById('distA').addEventListener('change', () => {
  const idx = parseInt(document.getElementById('distA').value);
  setFarthestOpponent(idx);
  calcDistance();
  buildAllDistances(stadien[idx].id);
});
document.getElementById('distB').addEventListener('change', calcDistance);

// Orientierungswechsel / Resize
window.addEventListener('resize', () => {
  map.invalidateSize();
  if (window.innerWidth > 768) {
    document.querySelector('.sidebar').classList.remove('tab-active');
    document.getElementById('distSection').style.display = '';
  }
});
</script>
</body>
</html>
